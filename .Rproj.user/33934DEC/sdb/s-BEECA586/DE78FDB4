{
    "collab_server" : "",
    "contents" : "#' plot decision table from a \"dec.table\" object.\n#' @description \\code{plot} method for class \"\\code{dec.table}\"\n#' @param x an object of class \\code{\"dec.table\"}, a result of a call to \\code{dec.table}.\n#' @param ... Not used argument.\n#' @details \\code{plot.dec.table} prints the decision boundarys.\n#' @import graphics\n#' @export\nplot.dec.table <- function(x, ...) {\n  n <- x$n\n  nc <- cumsum(n)\n  r <- x$E\n  s <- x$D\n  su <- x$DU\n  col <- c(\"cadetblue1\", \"darkorchid2\", \"indianred2\", \"seagreen2\")\n  plot(nc, r, xaxt = \"n\", ylab = \"Boundary\", xlab = 'Sample Size', ylim = c(0, max(su)+2.3), type = \"o\", col=col[1], main = \"Decision Plot\", panel.first = grid())\n  points(nc, s + 1, type = \"o\", col = col[2])\n  points(nc, su + 1, type = \"o\", col = col[3])\n  axis(1, at = nc, labels = nc)\n  polygon(c(nc, rev(nc)), c(r + 0.05, rev(s + 1 - 0.05)), col = col[4], border = NA)\n  polygon(c(nc, rev(nc)), c(rep(0,length(nc)), rev(r - 0.05)), col = col[1], border = NA)\n  polygon(c(nc, rev(nc)), c(s + 1 + 0.05, rev(su + 1 - 0.05)), col = col[2], border = NA)\n  polygon(c(nc, rev(nc)), c(su + 1 + 0.05, rev(rep(max(su)+2, length(nc)))), col = col[3], border = NA)\n  legend(\"top\", c(\"E (<=)\", \"D (>=)\", \"DU (>=)\", \"S\"), horiz = TRUE, fill = col)\n}\n\n\n#' print decision table from a \"dec.table\" object.\n#' @description \\code{print} method for class \"\\code{dec.table}\"\n#' @param x an object of class \\code{\"dec.table\"}, a result of a call to \\code{dec.table}.\n#' @param ... Not used argument.\n#' @details \\code{print.dec.table} prints the decision table with legend keys.\n#' @export\nprint.dec.table <- function(x, ...) {\n  print(x$table)\n  cat(\"\\n\")\n  cat(\"\t  Row : Number of DLTs\", \"\\n\")\n  cat(\"Column : Number of subjects\", \"\\n\")\n  cat(\"     E : Escalate to the next higher dose\", \"\\n\")\n  cat(\"     S : Stay at the same dose\", \"\\n\")\n  cat(\"     D : De-escalate to the previous lower dose\", \"\\n\")\n  cat(\"    DU : De-escalate and never use this dose again\", \"\\n\")\n}\n\n#' plot simulation results from a dec.sim object\n#' @description Three plots are currently available: a plot of true toxicity at each dose level (\\code{type = \"s\"}); a bar plot of the probability of selecting as the MTD for each dose level (\\code{type = \"prob\"}); a bar plot of the average number of patients treated at each dose level (\\code{type = \"np\"}); a bar plot of the average number of patients experienced DLT at each dose level (\\code{type = \"dlt\"}) and \\code{type = \"all\"} generates all above plots.\n#' @param x an object of class \\code{\"dec.sim\"} or \\code{\"sl.sim\"}, a result of a call to \\code{dec.sim} or \\code{sl.sim}.\n#' @param pt a vector with target toxicity for each scenario.\n#' @param s scenario to be plotted. Defaults to 1.\n#' @param type plot type. See descriptions above.\n#' @param label a logical value indicating if values are shown on plot.\n#' @param col graphical parameter \\code{col}; see details \\code{\\link{par}}.\n#' @param text.col plotting color of text shown.\n#' @param cex graphical parameter \\code{col}; see details \\code{\\link{par}}.\n#' @param ... arguments to be passed to \\code{\\link{plot}} methods.\n#' @import graphics\n#' @export\n#' @examples \n#' # generate decision table\n#' dt <- dec.table(0.6,0.4,0.2,0.3,0.3,c(3,3,3))\n#' # simulate trials from test data \n#' test.file <- system.file(\"extdata\", \"testS.csv\", package = \"tsdf\")\n#' out <- sl.sim(dt$table, test.file)\n#' plot(out, pt=rep(0.3,2), s=1, type=\"all\")\n#' plot(out, pt=rep(0.3,2), s=2, type=\"prob\")\n#' plot(out, pt=rep(0.3,2), s=1, type=\"np\")\n#' plot(out, pt=rep(0.3,2), s=2, type=\"dlt\")\nplot.dec.sim <- function(x, pt, s = 1, type = c(\"all\", \"s\", \"prob\", \"np\", \"dlt\"), label = TRUE, col = \"cornflowerblue\", text.col = \"darkblue\", cex = 1, ...) {\n  type <- match.arg(type)\n  if (class(x)[1] == \"sl.sim\") {\n    obj <- x[[s]]\n    ns <- length(x)\n  } else {\n    obj <- x\n    ns <- 1\n  }\n  truep <- obj$truep\n  n_dose <- length(truep)\n  names.arg <- 1:n_dose\n  scen <- paste(\"( Scenario\", s, \")\")\n  if (missing(pt)) {\n    print(\"No target toxicity/mtd shown\")\n  }\n  else if (length(pt) != ns) {\n    stop(\"true toxicity is a vector with length = # of cenarios\")\n  } else {\n    if(max(truep) < pt[s]) {\n      print(\"MTD is higher than highest dose\")\n    } else if(min(truep) > pt[s]) {\n      print(\"MTD is lower than lowest dose\")\n    } \n    else {\n      mtd <- max(which(truep <= pt[s]))\n      names.arg[mtd] <- paste(mtd, \"(MTD)\")\n    }\n  }\n  if (type == \"all\") {\n    par(mfrow = c(2, 2), cex = cex)\n    plot(x, pt, s, \"s\", label, col, text.col, cex, ...)\n    plot(x, pt, s, \"prob\", label, col, text.col, cex, ...)\n    plot(x, pt, s, \"dlt\", label, col, text.col, cex, ...)\n    plot(x, pt, s, \"np\", label, col, text.col, cex, ...)\t\t\n  }\n  if (type == \"prob\") {\n    ans <- obj$mtd.prob[1:n_dose]\n    names(ans) <- NULL\n    out <- barplot(rep(NA, n_dose), xlab = \"Dose level\", names.arg = names.arg, panel.first = box(), ylim = c(0, max(ans) * 1.1))\n    grid()\n    barplot(ans, add = TRUE, col = col)\n    title(paste(\"Probability of selection\", scen))\n    if (label) {\n      text(out, ans, labels = ans, pos = 3, cex = cex, col = text.col)\n    }\n  }\n  if (type == \"dlt\") {\n    ans <- obj$dlt\n    out <- barplot(rep(NA, n_dose), xlab = \"Dose level\", names.arg = names.arg, panel.first = box(), ylim = c(0, max(ans) * 1.1))\n    grid()\n    barplot(ans, add = TRUE, col = col)\n    title(paste(\"Average number of DLTs\", scen))\n    if (label) {\n      text(out, ans, labels = ans, pos = 3, cex = cex, col = text.col)\n    }\n  }\n  if (type == \"np\") {\n    ans <- obj$n.patients\n    out <- barplot(rep(NA, n_dose), xlab = \"Dose level\", names.arg = names.arg, panel.first = box(), ylim = c(0, max(ans) * 1.1))\n    grid()\n    barplot(ans, add = TRUE, col = col)\n    title(paste(\"Average number of patients\", scen))\n    if (label) {\n      text(out, ans, labels = ans, pos = 3, cex = cex, col = text.col)\n    }\n  }\n  if (type == \"s\") {\n    out <- plot(1:n_dose, truep, xlab = \"Dose level\", ylab = \"Toxicity\", col = col, type = \"b\", ylim = c(min(truep) * 0.9, max(truep) * 1.1), xaxt = \"n\", pch = 19, panel.first = c(box(), grid()))\n    axis(1, at = 1:n_dose, labels = names.arg)\n    title(paste(\"True toxicity\", scen))\n    if (!missing(pt)) {\n      abline(pt[s], 0, lty = 5)\n      text(n_dose/2, pt[s], labels = paste(\"Target =\", pt[s]), pos = 3, cex = cex, col = text.col)\n    }\n    if (label) {\n      text(1:n_dose, truep, labels = truep, pos = 3, cex = cex, col = text.col)\n    }\n  }\n}\n\n\n#' Summarizing simulation results from a dec.sim object\n#' @description \\code{summary} method for class \\code{\"dec.sim\"}.\n#' @details \\code{summary} is used for formating important statistics for dose-finding simulation. Giving the target toxicity, it returns the probability of selecting current dose level as the MTD, probability of selecting the true MTD, probability of subjects treated at or below the true MTD, etc. The MTD is defined as the highest dose level such that the toxicity probability is less than target toxicity probability, if target is less than the smallest probability, then the lowest dose level is set as MTD. For example, if target is 0.3 and true toxicity for five doses are 0.1, 0.25, 0.35, 0.40, then MTD is dose 2.\n#' @param object an object of class \\code{\"dec.sim\"}, a result of a call to \\code{dec.sim} or \\code{sl.sim}.\n#' @param pt target toxicity for each scenario.\n#' @param ... Not used argument.\n#' @examples \n#' test.file <- system.file(\"extdata\", \"testS.csv\", package = \"tsdf\")\n#' dt <- dec.table(0.6,0.4,0.2,0.3,0.3,c(3,3,3))\n#' out <- sl.sim(dt$table, test.file)\n#' pt <- c(0.3, 0.4)\n#' summary(out, pt)\n#' @import stats\n#' @export\nsummary.dec.sim <- function(object, pt, ...) {\n  if(missing(pt)) {\n    stop(\"Missing true toxicity.\")\n  }\n  if(class(object)[1] == \"sl.sim\" & length(object) != length(pt)) {\n    warning(\"pt length not equal to number of scenarios; only returns the first scenario stats\")\n  }\n  ns <- length(pt)\n  avg.np <- rep(0, ns)\n  avg.dose <- rep(0, ns)\n  avg.prob <- rep(0, ns)\n  out <- vector(\"list\", ns)\n  for(i in 1:ns) {\n    if(class(object)[1] == \"sl.sim\"){\n      ans <- object[[i]]\n    } else {\n      ans <- object\n    }\n    truep <- ans$truep\n    n_dose <- length(truep)\n    res <- matrix(0, n_dose, 5)\n    colnames(res) <- c(\"Level\", \"Truth\", \"MTD\", \"DLT\", \"NP\")\n    res[, 1] <- 1:n_dose \n    res[, 2] <- truep\n    res[, 3] <- ans$mtd.prob[1:n_dose]\n    res[, 4] <- ans$dlt\n    res[, 5] <- ans$n.patients\n    # calculate stats\n    avg.np[i] <- sum(res[, 5])\n    if(max(truep) < pt[i]) {\n      mtd.dose <- \"higher than highest dose\"\n      avg.dose[i] <- ans$mtd.prob[6]\n      avg.prob[i] <- 1\n    } else if(min(truep) > pt[i]) {\n      mtd.dose <- \"lower than lowest dose\"\n      avg.dose[i] <- ans$mtd.prob[5]\n      avg.prob[i] <- 0\n    } else {\n      mtd.dose <- max(which(truep <= pt[i]))\n      avg.dose[i] <- res[, 3][mtd.dose]\n      avg.prob[i] <-sum(res[, 5][truep <= pt[i]])/sum(res[, 5])\n    }\n    \n    out[[i]] <- list(dose.stats = res, prob.select = avg.dose[i], at.below.mtd = avg.prob[i], mtd = mtd.dose, nsim = ans$nsim, pt = pt[i], avg.np = avg.np[i], start.level = ans$start.level)\n  }\n  class(out) <- \"summary.dec.sim\"\n  out\n}\n\n#' @export\nprint.summary.dec.sim <- function(x, ...) {\n  cat(\"What does each column represent ?\", \"\\n\\n\")\n  cat(\"Level : Dose level\", \"\\n\")\n  cat(\"Truth : True toxicity probability\", \"\\n\")\n  cat(\"MTD : The probability of selecting current dose level as the MTD\", \"\\n\")\n  cat(\"DLT : The average number of subjects experienced DLT at current dose level\", \"\\n\")\n  cat(\"NP : The average number of subjects treated at current dose level\", \"\\n\\n\")\n  \n  for(i in 1:length(x)){\n    # table legends\n    cat(\"Scenario \", i, \"\\n\\n\")\n    cat(\"Simulation results are based on\", x[[i]]$nsim, \"simulated trials\",\"\\n\")\n    cat(\"Starting dose level is\", x[[i]]$start.level, \"; MTD is dose\", x[[i]]$mtd, \"\\n\")\n    cat(\"Target toxicity probability =\", x[[i]]$pt, \"\\n\")\n    cat(\"Average number of subjects =\", x[[i]]$avg.np, \"\\n\")\n    cat(\"Probability of selecting the true MTD =\", x[[i]]$prob.select, \"\\n\")\n    cat(\"Probability of subjects treated at or below the true MTD =\", x[[i]]$at.below.mtd, \"\\n\\n\")\n    print(as.data.frame(x[[i]]$dose.stats ))\n    cat(\"\\n\")\n  }\n}\n\n\n\n\n#' print Zhong's design from a \"opt.design\" object.\n#' @description \\code{print} method for class \"\\code{opt.design}\"\n#' @param x an object of class \\code{\"opt.design\"}, a result of a call to \\code{opt.design}.\n#' @param ... not used argument.\n#' @export\nprint.opt.design <- function(x, ...) {\n  cat(\"\\n Zhong's\", x$stage,\"stage Phase II design \\n\\n\")\n  cat(\"Minimal response rate: \", unique(x$pc), \"\\n\")\n  cat(\"Unacceptable response rate: \", x$pt, \"\\n\")\n  cat(\"Left-side type 1 error: \",x$alpha1, \"\\n\")\n  cat(\"Right-side type 1 error: \",x$alpha2, \"\\n\")\n  cat(\"Type 2 error: \",x$beta, \"\\n\\n\")\n  cat(\"Optimal design : \", \"\\n\")\n  print(c(x$bdry, x$n))\n  cat(\"True errors : \", \"\\n\")\n  print(x$error)\n  cat(\"\\n\")\n}\n\n\n",
    "created" : 1503074451139.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3794284815",
    "id" : "DE78FDB4",
    "lastKnownWriteTime" : 1503074739,
    "last_content_update" : 1503074739982,
    "path" : "C:/Users/wguo25/Desktop/GitHub/tsdf/R/utility.R",
    "project_path" : "R/utility.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}